const translations = {
    en: {
        subtitle: "Your personal financial assistant",
        tab_currency: "Currency",
        tab_loan: "Loan",
        tab_interest: "Interest",
        tab_pv: "Present Value",
        currency_title: "Currency Converter",
        label_amount: "Amount",
        label_from: "From",
        label_to: "To",
        btn_convert: "Convert",
        result_placeholder: "Result will appear here",
        loan_title: "Loan Calculator",
        label_principal: "Principal Amount",
        label_rate: "Annual Rate (%)",
        label_years: "Term (Years)",
        btn_calculate_loan: "Calculate Loan",
        interest_title: "Interest Calculator",
        label_time: "Time (Years)",
        label_type: "Type",
        option_simple: "Simple Interest",
        option_compound: "Compound Interest",
        label_frequency: "Frequency",
        freq_annually: "Annually",
        freq_monthly: "Monthly",
        freq_quarterly: "Quarterly",
        btn_calculate_interest: "Calculate Interest",
        pv_title: "Present Value Calculator",
        label_future_value: "Future Value (Target)",
        freq_semi_annually: "Semi-Annually",
        freq_daily: "Daily",
        btn_calculate_pv: "Calculate Present Value"
    },
    pt: {
        subtitle: "Seu assistente financeiro pessoal",
        tab_currency: "Moeda",
        tab_loan: "EmprÃ©stimo",
        tab_interest: "Juros",
        tab_pv: "Valor Presente",
        currency_title: "Conversor de Moedas",
        label_amount: "Valor",
        label_from: "De",
        label_to: "Para",
        btn_convert: "Converter",
        result_placeholder: "O resultado aparecerÃ¡ aqui",
        loan_title: "Calculadora de EmprÃ©stimo",
        label_principal: "Valor Principal",
        label_rate: "Taxa Anual (%)",
        label_years: "Prazo (Anos)",
        btn_calculate_loan: "Calcular EmprÃ©stimo",
        interest_title: "Calculadora de Juros",
        label_time: "Tempo (Anos)",
        label_type: "Tipo",
        option_simple: "Juros Simples",
        option_compound: "Juros Compostos",
        label_frequency: "FrequÃªncia",
        freq_annually: "Anualmente",
        freq_monthly: "Mensalmente",
        freq_quarterly: "Trimestralmente",
        btn_calculate_interest: "Calcular Juros",
        pv_title: "Calculadora de Valor Presente",
        label_future_value: "Valor Futuro (Meta)",
        freq_semi_annually: "Semestralmente",
        freq_daily: "Diariamente",
        btn_calculate_pv: "Calcular Valor Presente"
    },
    es: {
        subtitle: "Tu asistente financiero personal",
        tab_currency: "Divisa",
        tab_loan: "PrÃ©stamo",
        tab_interest: "InterÃ©s",
        tab_pv: "Valor Presente",
        currency_title: "Conversor de Divisas",
        label_amount: "Cantidad",
        label_from: "De",
        label_to: "A",
        btn_convert: "Convertir",
        result_placeholder: "El resultado aparecerÃ¡ aquÃ­",
        loan_title: "Calculadora de PrÃ©stamos",
        label_principal: "Monto Principal",
        label_rate: "Tasa Anual (%)",
        label_years: "Plazo (AÃ±os)",
        btn_calculate_loan: "Calcular PrÃ©stamo",
        interest_title: "Calculadora de Intereses",
        label_time: "Tiempo (AÃ±os)",
        label_type: "Tipo",
        option_simple: "InterÃ©s Simple",
        option_compound: "InterÃ©s Compuesto",
        label_frequency: "Frecuencia",
        freq_annually: "Anualmente",
        freq_monthly: "Mensualmente",
        freq_quarterly: "Trimestralmente",
        btn_calculate_interest: "Calcular InterÃ©s",
        pv_title: "Calculadora de Valor Presente",
        label_future_value: "Valor Futuro (Meta)",
        freq_semi_annually: "Semestralmente",
        freq_daily: "Diariamente",
        btn_calculate_pv: "Calcular Valor Presente"
    },
    fr: {
        subtitle: "Votre assistant financier personnel",
        tab_currency: "Devise",
        tab_loan: "PrÃªt",
        tab_interest: "IntÃ©rÃªt",
        tab_pv: "Valeur Actuelle",
        currency_title: "Convertisseur de Devises",
        label_amount: "Montant",
        label_from: "De",
        label_to: "Ã€",
        btn_convert: "Convertir",
        result_placeholder: "Le rÃ©sultat apparaÃ®tra ici",
        loan_title: "Calculatrice de PrÃªt",
        label_principal: "Montant Principal",
        label_rate: "Taux Annuel (%)",
        label_years: "DurÃ©e (AnnÃ©es)",
        btn_calculate_loan: "Calculer le PrÃªt",
        interest_title: "Calculatrice d'IntÃ©rÃªts",
        label_time: "Temps (AnnÃ©es)",
        label_type: "Type",
        option_simple: "IntÃ©rÃªt Simple",
        option_compound: "IntÃ©rÃªt ComposÃ©",
        label_frequency: "FrÃ©quence",
        freq_annually: "Annuellement",
        freq_monthly: "Mensuellement",
        freq_quarterly: "Trimestriellement",
        btn_calculate_interest: "Calculer l'IntÃ©rÃªt",
        pv_title: "Calculatrice de Valeur Actuelle",
        label_future_value: "Valeur Future (Objectif)",
        freq_semi_annually: "Semestriellement",
        freq_daily: "Quotidiennement",
        btn_calculate_pv: "Calculer la Valeur Actuelle"
    },
    de: {
        subtitle: "Ihr persÃ¶nlicher Finanzassistent",
        tab_currency: "WÃ¤hrung",
        tab_loan: "Kredit",
        tab_interest: "Zinsen",
        tab_pv: "Barwert",
        currency_title: "WÃ¤hrungsrechner",
        label_amount: "Betrag",
        label_from: "Von",
        label_to: "Zu",
        btn_convert: "Konvertieren",
        result_placeholder: "Ergebnis wird hier angezeigt",
        loan_title: "Kreditrechner",
        label_principal: "Kapitalbetrag",
        label_rate: "Jahreszins (%)",
        label_years: "Laufzeit (Jahre)",
        btn_calculate_loan: "Kredit berechnen",
        interest_title: "Zinsrechner",
        label_time: "Zeit (Jahre)",
        label_type: "Typ",
        option_simple: "Einfache Zinsen",
        option_compound: "Zinseszins",
        label_frequency: "HÃ¤ufigkeit",
        freq_annually: "JÃ¤hrlich",
        freq_monthly: "Monatlich",
        freq_quarterly: "VierteljÃ¤hrlich",
        btn_calculate_interest: "Zinsen berechnen",
        pv_title: "Barwertrechner",
        label_future_value: "ZukÃ¼nftiger Wert (Ziel)",
        freq_semi_annually: "HalbjÃ¤hrlich",
        freq_daily: "TÃ¤glich",
        btn_calculate_pv: "Barwert berechnen"
    },
    zh: {
        subtitle: "æ‚¨çš„ä¸ªäººç†è´¢åŠ©æ‰‹",
        tab_currency: "è´§å¸",
        tab_loan: "è´·æ¬¾",
        tab_interest: "åˆ©æ¯",
        tab_pv: "çŽ°å€¼",
        currency_title: "è´§å¸è½¬æ¢å™¨",
        label_amount: "é‡‘é¢",
        label_from: "ä»Ž",
        label_to: "åˆ°",
        btn_convert: "è½¬æ¢",
        result_placeholder: "ç»“æžœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ",
        loan_title: "è´·æ¬¾è®¡ç®—å™¨",
        label_principal: "æœ¬é‡‘é‡‘é¢",
        label_rate: "å¹´åˆ©çŽ‡ (%)",
        label_years: "æœŸé™ (å¹´)",
        btn_calculate_loan: "è®¡ç®—è´·æ¬¾",
        interest_title: "åˆ©æ¯è®¡ç®—å™¨",
        label_time: "æ—¶é—´ (å¹´)",
        label_type: "ç±»åž‹",
        option_simple: "å•åˆ©",
        option_compound: "å¤åˆ©",
        label_frequency: "é¢‘çŽ‡",
        freq_annually: "æ¯å¹´",
        freq_monthly: "æ¯æœˆ",
        freq_quarterly: "æ¯å­£åº¦",
        btn_calculate_interest: "è®¡ç®—åˆ©æ¯",
        pv_title: "çŽ°å€¼è®¡ç®—å™¨",
        label_future_value: "æœªæ¥ä»·å€¼ (ç›®æ ‡)",
        freq_semi_annually: "æ¯åŠå¹´",
        freq_daily: "æ¯å¤©",
        btn_calculate_pv: "è®¡ç®—çŽ°å€¼"
    },
    ar: {
        subtitle: "Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ",
        tab_currency: "Ø¹Ù…Ù„Ø©",
        tab_loan: "Ù‚Ø±Ø¶",
        tab_interest: "ÙØ§Ø¦Ø¯Ø©",
        tab_pv: "Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
        currency_title: "Ù…Ø­ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª",
        label_amount: "Ø§Ù„Ù…Ø¨Ù„Øº",
        label_from: "Ù…Ù†",
        label_to: "Ø¥Ù„Ù‰",
        btn_convert: "ØªØ­ÙˆÙŠÙ„",
        result_placeholder: "Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù‡Ù†Ø§",
        loan_title: "Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø±ÙˆØ¶",
        label_principal: "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ",
        label_rate: "Ù…Ø¹Ø¯Ù„ Ø³Ù†ÙˆÙŠ (%)",
        label_years: "Ø§Ù„Ù…Ø¯Ø© (Ø³Ù†ÙˆØ§Øª)",
        btn_calculate_loan: "Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚Ø±Ø¶",
        interest_title: "Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙØ§Ø¦Ø¯Ø©",
        label_time: "Ø§Ù„ÙˆÙ‚Øª (Ø³Ù†ÙˆØ§Øª)",
        label_type: "Ø§Ù„Ù†ÙˆØ¹",
        option_simple: "ÙØ§Ø¦Ø¯Ø© Ø¨Ø³ÙŠØ·Ø©",
        option_compound: "ÙØ§Ø¦Ø¯Ø© Ù…Ø±ÙƒØ¨Ø©",
        label_frequency: "Ø§Ù„ØªÙƒØ±Ø§Ø±",
        freq_annually: "Ø³Ù†ÙˆÙŠØ§Ù‹",
        freq_monthly: "Ø´Ù‡Ø±ÙŠØ§Ù‹",
        freq_quarterly: "Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ",
        btn_calculate_interest: "Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ§Ø¦Ø¯Ø©",
        pv_title: "Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
        label_future_value: "Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ© (Ø§Ù„Ù‡Ø¯Ù)",
        freq_semi_annually: "Ù†ØµÙ Ø³Ù†ÙˆÙŠ",
        freq_daily: "ÙŠÙˆÙ…ÙŠØ§Ù‹",
        btn_calculate_pv: "Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©"
    }
};

document.addEventListener('DOMContentLoaded', () => {
    // Language Selector Logic
    const languageBtn = document.getElementById('language-btn');
    const languageDropdown = document.getElementById('language-dropdown');
    const languageOptions = languageDropdown.querySelectorAll('li');

    const flags = {
        en: 'ðŸ‡ºðŸ‡¸',
        pt: 'ðŸ‡§ðŸ‡·',
        es: 'ðŸ‡ªðŸ‡¸',
        fr: 'ðŸ‡«ðŸ‡·',
        de: 'ðŸ‡©ðŸ‡ª',
        zh: 'ðŸ‡¨ðŸ‡³',
        ar: 'ðŸ‡¸ðŸ‡¦'
    };

    const updateLanguage = (lang) => {
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

        // Update button flag
        if (flags[lang]) {
            languageBtn.textContent = flags[lang];
        }

        const elements = document.querySelectorAll('[data-i18n]');
        elements.forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) {
                if (element.tagName === 'INPUT' && element.getAttribute('placeholder')) {
                    // For inputs, we might want to translate placeholders if we had keys for them
                    // But currently keys are for text content. 
                    // Let's assume keys are for text content mostly.
                } else {
                    element.textContent = translations[lang][key];
                }
            }
        });
    };

    // Toggle dropdown
    languageBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        languageDropdown.classList.toggle('show');
    });

    // Select language
    languageOptions.forEach(option => {
        option.addEventListener('click', () => {
            const lang = option.getAttribute('data-value');
            updateLanguage(lang);
            languageDropdown.classList.remove('show');
        });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!languageBtn.contains(e.target) && !languageDropdown.contains(e.target)) {
            languageDropdown.classList.remove('show');
        }
    });

    // Initialize with default language (English)
    updateLanguage('en');

    // Tab Switching
    const tabs = document.querySelectorAll('.tab-btn');
    const calculators = document.querySelectorAll('.calculator');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            calculators.forEach(c => c.classList.remove('active'));

            tab.classList.add('active');
            const target = tab.dataset.target;
            document.getElementById(target).classList.add('active');
        });
    });

    // Interest Type Toggle
    const interestType = document.getElementById('interest-type');
    const frequencyGroup = document.getElementById('frequency-group');

    interestType.addEventListener('change', () => {
        if (interestType.value === 'compound') {
            frequencyGroup.style.display = 'block';
        } else {
            frequencyGroup.style.display = 'none';
        }
    });

    // Helper to format currency
    const formatCurrency = (num, currency = 'USD') => {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(num);
    };

    // --- Currency Converter ---
    document.getElementById('btn-currency').addEventListener('click', async () => {
        const amount = document.getElementById('currency-amount').value;
        const from = document.getElementById('currency-from').value;
        const to = document.getElementById('currency-to').value;
        const resultDiv = document.getElementById('result-currency');

        if (!amount || amount <= 0) {
            resultDiv.innerHTML = '<span class="placeholder" style="color: #ef4444;">Please enter a valid amount</span>';
            return;
        }

        resultDiv.innerHTML = '<span class="placeholder">Converting...</span>';

        try {
            const response = await fetch('/.netlify/functions/currency', {
                method: 'POST',
                body: JSON.stringify({ amount, from, to })
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();

            resultDiv.innerHTML = `
                <div class="result-value">${formatCurrency(data.converted_amount, to)}</div>
                <div class="result-detail">1 ${from} = ${data.rate.toFixed(4)} ${to}</div>
            `;
        } catch (error) {
            resultDiv.innerHTML = `<span class="placeholder" style="color: #ef4444;">Error: ${error.message}</span>`;
        }
    });

    // --- Loan Calculator ---
    document.getElementById('btn-loan').addEventListener('click', async () => {
        const principal = document.getElementById('loan-principal').value;
        const rate = document.getElementById('loan-rate').value;
        const years = document.getElementById('loan-years').value;
        const resultDiv = document.getElementById('result-loan');

        if (!principal || !rate || !years) {
            resultDiv.innerHTML = '<span class="placeholder" style="color: #ef4444;">Please fill all fields</span>';
            return;
        }

        resultDiv.innerHTML = '<span class="placeholder">Calculating...</span>';

        try {
            const response = await fetch('/.netlify/functions/loan', {
                method: 'POST',
                body: JSON.stringify({ principal, rate, years })
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();

            resultDiv.innerHTML = `
                <div class="result-value">${formatCurrency(data.monthly_payment)} / mo</div>
                <div class="result-detail">Total Interest: ${formatCurrency(data.total_interest)}</div>
                <div class="result-detail">Total Payment: ${formatCurrency(data.total_payment)}</div>
            `;
        } catch (error) {
            resultDiv.innerHTML = `<span class="placeholder" style="color: #ef4444;">Error: ${error.message}</span>`;
        }
    });

    // --- Interest Calculator ---
    document.getElementById('btn-interest').addEventListener('click', async () => {
        const principal = document.getElementById('interest-principal').value;
        const rate = document.getElementById('interest-rate').value;
        const time = document.getElementById('interest-time').value;
        const type = document.getElementById('interest-type').value;
        const frequency = document.getElementById('interest-frequency').value;
        const resultDiv = document.getElementById('result-interest');

        if (!principal || !rate || !time) {
            resultDiv.innerHTML = '<span class="placeholder" style="color: #ef4444;">Please fill all fields</span>';
            return;
        }

        resultDiv.innerHTML = '<span class="placeholder">Calculating...</span>';

        try {
            const response = await fetch('/.netlify/functions/interest', {
                method: 'POST',
                body: JSON.stringify({ principal, rate, time, type, frequency })
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();

            resultDiv.innerHTML = `
                <div class="result-value">${formatCurrency(data.total_amount)}</div>
                <div class="result-detail">Interest Earned: ${formatCurrency(data.interest_earned)}</div>
            `;
        } catch (error) {
            resultDiv.innerHTML = `<span class="placeholder" style="color: #ef4444;">Error: ${error.message}</span>`;
        }
    });
    // --- Present Value Calculator ---
    document.getElementById('btn-pv').addEventListener('click', async () => {
        const future_value = document.getElementById('pv-future-value').value;
        const rate = document.getElementById('pv-rate').value;
        const years = document.getElementById('pv-years').value;
        const frequency = document.getElementById('pv-frequency').value;
        const resultDiv = document.getElementById('result-pv');

        if (!future_value || !rate || !years) {
            resultDiv.innerHTML = '<span class="placeholder" style="color: #ef4444;">Please fill all fields</span>';
            return;
        }

        resultDiv.innerHTML = '<span class="placeholder">Calculating...</span>';

        try {
            const response = await fetch('/.netlify/functions/present_value', {
                method: 'POST',
                body: JSON.stringify({ future_value, rate, years, frequency })
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();

            resultDiv.innerHTML = `
                <div class="result-value">${formatCurrency(data.present_value)}</div>
                <div class="result-detail">To reach ${formatCurrency(data.future_value)} in ${data.years} years</div>
                <div class="result-detail">Interest Needed: ${formatCurrency(data.interest_needed)}</div>
            `;
        } catch (error) {
            resultDiv.innerHTML = `<span class="placeholder" style="color: #ef4444;">Error: ${error.message}</span>`;
        }
    });
});
