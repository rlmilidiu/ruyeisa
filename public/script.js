const translations = {
    en: {
        subtitle: "Your personal financial assistant",
        tab_currency: "Currency",
        tab_loan: "Loan",
        tab_interest: "Interest",
        tab_pv: "Present Value",
        currency_title: "Currency Converter",
        label_amount: "Amount",
        label_from: "From",
        label_to: "To",
        btn_convert: "Convert",
        result_placeholder: "Result will appear here",
        loan_title: "Loan Calculator",
        label_principal: "Principal Amount",
        label_rate: "Annual Rate (%)",
        label_years: "Term (Years)",
        btn_calculate_loan: "Calculate Loan",
        interest_title: "Interest Calculator",
        label_time: "Time (Years)",
        label_type: "Type",
        option_simple: "Simple Interest",
        option_compound: "Compound Interest",
        label_frequency: "Frequency",
        freq_annually: "Annually",
        freq_monthly: "Monthly",
        freq_quarterly: "Quarterly",
        btn_calculate_interest: "Calculate Interest",
        pv_title: "Present Value Calculator",
        label_future_value: "Future Value (Target)",
        freq_semi_annually: "Semi-Annually",
        freq_daily: "Daily",
        btn_calculate_pv: "Calculate Present Value"
    },
    pt: {
        subtitle: "Seu assistente financeiro pessoal",
        tab_currency: "Moeda",
        tab_loan: "Empréstimo",
        tab_interest: "Juros",
        tab_pv: "Valor Presente",
        currency_title: "Conversor de Moedas",
        label_amount: "Valor",
        label_from: "De",
        label_to: "Para",
        btn_convert: "Converter",
        result_placeholder: "O resultado aparecerá aqui",
        loan_title: "Calculadora de Empréstimo",
        label_principal: "Valor Principal",
        label_rate: "Taxa Anual (%)",
        label_years: "Prazo (Anos)",
        btn_calculate_loan: "Calcular Empréstimo",
        interest_title: "Calculadora de Juros",
        label_time: "Tempo (Anos)",
        label_type: "Tipo",
        option_simple: "Juros Simples",
        option_compound: "Juros Compostos",
        label_frequency: "Frequência",
        freq_annually: "Anualmente",
        freq_monthly: "Mensalmente",
        freq_quarterly: "Trimestralmente",
        btn_calculate_interest: "Calcular Juros",
        pv_title: "Calculadora de Valor Presente",
        label_future_value: "Valor Futuro (Meta)",
        freq_semi_annually: "Semestralmente",
        freq_daily: "Diariamente",
        btn_calculate_pv: "Calcular Valor Presente"
    },
    es: {
        subtitle: "Tu asistente financiero personal",
        tab_currency: "Divisa",
        tab_loan: "Préstamo",
        tab_interest: "Interés",
        tab_pv: "Valor Presente",
        currency_title: "Conversor de Divisas",
        label_amount: "Cantidad",
        label_from: "De",
        label_to: "A",
        btn_convert: "Convertir",
        result_placeholder: "El resultado aparecerá aquí",
        loan_title: "Calculadora de Préstamos",
        label_principal: "Monto Principal",
        label_rate: "Tasa Anual (%)",
        label_years: "Plazo (Años)",
        btn_calculate_loan: "Calcular Préstamo",
        interest_title: "Calculadora de Intereses",
        label_time: "Tiempo (Años)",
        label_type: "Tipo",
        option_simple: "Interés Simple",
        option_compound: "Interés Compuesto",
        label_frequency: "Frecuencia",
        freq_annually: "Anualmente",
        freq_monthly: "Mensualmente",
        freq_quarterly: "Trimestralmente",
        btn_calculate_interest: "Calcular Interés",
        pv_title: "Calculadora de Valor Presente",
        label_future_value: "Valor Futuro (Meta)",
        freq_semi_annually: "Semestralmente",
        freq_daily: "Diariamente",
        btn_calculate_pv: "Calcular Valor Presente"
    },
    fr: {
        subtitle: "Votre assistant financier personnel",
        tab_currency: "Devise",
        tab_loan: "Prêt",
        tab_interest: "Intérêt",
        tab_pv: "Valeur Actuelle",
        currency_title: "Convertisseur de Devises",
        label_amount: "Montant",
        label_from: "De",
        label_to: "À",
        btn_convert: "Convertir",
        result_placeholder: "Le résultat apparaîtra ici",
        loan_title: "Calculatrice de Prêt",
        label_principal: "Montant Principal",
        label_rate: "Taux Annuel (%)",
        label_years: "Durée (Années)",
        btn_calculate_loan: "Calculer le Prêt",
        interest_title: "Calculatrice d'Intérêts",
        label_time: "Temps (Années)",
        label_type: "Type",
        option_simple: "Intérêt Simple",
        option_compound: "Intérêt Composé",
        label_frequency: "Fréquence",
        freq_annually: "Annuellement",
        freq_monthly: "Mensuellement",
        freq_quarterly: "Trimestriellement",
        btn_calculate_interest: "Calculer l'Intérêt",
        pv_title: "Calculatrice de Valeur Actuelle",
        label_future_value: "Valeur Future (Objectif)",
        freq_semi_annually: "Semestriellement",
        freq_daily: "Quotidiennement",
        btn_calculate_pv: "Calculer la Valeur Actuelle"
    },
    de: {
        subtitle: "Ihr persönlicher Finanzassistent",
        tab_currency: "Währung",
        tab_loan: "Kredit",
        tab_interest: "Zinsen",
        tab_pv: "Barwert",
        currency_title: "Währungsrechner",
        label_amount: "Betrag",
        label_from: "Von",
        label_to: "Zu",
        btn_convert: "Konvertieren",
        result_placeholder: "Ergebnis wird hier angezeigt",
        loan_title: "Kreditrechner",
        label_principal: "Kapitalbetrag",
        label_rate: "Jahreszins (%)",
        label_years: "Laufzeit (Jahre)",
        btn_calculate_loan: "Kredit berechnen",
        interest_title: "Zinsrechner",
        label_time: "Zeit (Jahre)",
        label_type: "Typ",
        option_simple: "Einfache Zinsen",
        option_compound: "Zinseszins",
        label_frequency: "Häufigkeit",
        freq_annually: "Jährlich",
        freq_monthly: "Monatlich",
        freq_quarterly: "Vierteljährlich",
        btn_calculate_interest: "Zinsen berechnen",
        pv_title: "Barwertrechner",
        label_future_value: "Zukünftiger Wert (Ziel)",
        freq_semi_annually: "Halbjährlich",
        freq_daily: "Täglich",
        btn_calculate_pv: "Barwert berechnen"
    },
    zh: {
        subtitle: "您的个人理财助手",
        tab_currency: "货币",
        tab_loan: "贷款",
        tab_interest: "利息",
        tab_pv: "现值",
        currency_title: "货币转换器",
        label_amount: "金额",
        label_from: "从",
        label_to: "到",
        btn_convert: "转换",
        result_placeholder: "结果将显示在这里",
        loan_title: "贷款计算器",
        label_principal: "本金金额",
        label_rate: "年利率 (%)",
        label_years: "期限 (年)",
        btn_calculate_loan: "计算贷款",
        interest_title: "利息计算器",
        label_time: "时间 (年)",
        label_type: "类型",
        option_simple: "单利",
        option_compound: "复利",
        label_frequency: "频率",
        freq_annually: "每年",
        freq_monthly: "每月",
        freq_quarterly: "每季度",
        btn_calculate_interest: "计算利息",
        pv_title: "现值计算器",
        label_future_value: "未来价值 (目标)",
        freq_semi_annually: "每半年",
        freq_daily: "每天",
        btn_calculate_pv: "计算现值"
    },
    ar: {
        subtitle: "مساعدك المالي الشخصي",
        tab_currency: "عملة",
        tab_loan: "قرض",
        tab_interest: "فائدة",
        tab_pv: "القيمة الحالية",
        currency_title: "محول العملات",
        label_amount: "المبلغ",
        label_from: "من",
        label_to: "إلى",
        btn_convert: "تحويل",
        result_placeholder: "ستظهر النتيجة هنا",
        loan_title: "حاسبة القروض",
        label_principal: "المبلغ الأصلي",
        label_rate: "معدل سنوي (%)",
        label_years: "المدة (سنوات)",
        btn_calculate_loan: "حساب القرض",
        interest_title: "حاسبة الفائدة",
        label_time: "الوقت (سنوات)",
        label_type: "النوع",
        option_simple: "فائدة بسيطة",
        option_compound: "فائدة مركبة",
        label_frequency: "التكرار",
        freq_annually: "سنوياً",
        freq_monthly: "شهرياً",
        freq_quarterly: "ربع سنوي",
        btn_calculate_interest: "حساب الفائدة",
        pv_title: "حاسبة القيمة الحالية",
        label_future_value: "القيمة المستقبلية (الهدف)",
        freq_semi_annually: "نصف سنوي",
        freq_daily: "يومياً",
        btn_calculate_pv: "حساب القيمة الحالية"
    }
};

document.addEventListener('DOMContentLoaded', () => {
    // Language Selector Logic
    const languageSelect = document.getElementById('language-select');

    const updateLanguage = (lang) => {
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

        const elements = document.querySelectorAll('[data-i18n]');
        elements.forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (translations[lang] && translations[lang][key]) {
                if (element.tagName === 'INPUT' && element.getAttribute('placeholder')) {
                    // For inputs, we might want to translate placeholders if we had keys for them
                    // But currently keys are for text content. 
                    // Let's assume keys are for text content mostly.
                } else {
                    element.textContent = translations[lang][key];
                }
            }
        });
    };

    languageSelect.addEventListener('change', (e) => {
        updateLanguage(e.target.value);
    });

    // Initialize with default language (English)
    updateLanguage('en');

    // Tab Switching
    const tabs = document.querySelectorAll('.tab-btn');
    const calculators = document.querySelectorAll('.calculator');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            calculators.forEach(c => c.classList.remove('active'));

            tab.classList.add('active');
            const target = tab.dataset.target;
            document.getElementById(target).classList.add('active');
        });
    });

    // Interest Type Toggle
    const interestType = document.getElementById('interest-type');
    const frequencyGroup = document.getElementById('frequency-group');

    interestType.addEventListener('change', () => {
        if (interestType.value === 'compound') {
            frequencyGroup.style.display = 'block';
        } else {
            frequencyGroup.style.display = 'none';
        }
    });

    // Helper to format currency
    const formatCurrency = (num, currency = 'USD') => {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency }).format(num);
    };

    // --- Currency Converter ---
    document.getElementById('btn-currency').addEventListener('click', async () => {
        const amount = document.getElementById('currency-amount').value;
        const from = document.getElementById('currency-from').value;
        const to = document.getElementById('currency-to').value;
        const resultDiv = document.getElementById('result-currency');

        if (!amount || amount <= 0) {
            resultDiv.innerHTML = '<span class="placeholder" style="color: #ef4444;">Please enter a valid amount</span>';
            return;
        }

        resultDiv.innerHTML = '<span class="placeholder">Converting...</span>';

        try {
            const response = await fetch('/.netlify/functions/currency', {
                method: 'POST',
                body: JSON.stringify({ amount, from, to })
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();

            resultDiv.innerHTML = `
                <div class="result-value">${formatCurrency(data.converted_amount, to)}</div>
                <div class="result-detail">1 ${from} = ${data.rate.toFixed(4)} ${to}</div>
            `;
        } catch (error) {
            resultDiv.innerHTML = `<span class="placeholder" style="color: #ef4444;">Error: ${error.message}</span>`;
        }
    });

    // --- Loan Calculator ---
    document.getElementById('btn-loan').addEventListener('click', async () => {
        const principal = document.getElementById('loan-principal').value;
        const rate = document.getElementById('loan-rate').value;
        const years = document.getElementById('loan-years').value;
        const resultDiv = document.getElementById('result-loan');

        if (!principal || !rate || !years) {
            resultDiv.innerHTML = '<span class="placeholder" style="color: #ef4444;">Please fill all fields</span>';
            return;
        }

        resultDiv.innerHTML = '<span class="placeholder">Calculating...</span>';

        try {
            const response = await fetch('/.netlify/functions/loan', {
                method: 'POST',
                body: JSON.stringify({ principal, rate, years })
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();

            resultDiv.innerHTML = `
                <div class="result-value">${formatCurrency(data.monthly_payment)} / mo</div>
                <div class="result-detail">Total Interest: ${formatCurrency(data.total_interest)}</div>
                <div class="result-detail">Total Payment: ${formatCurrency(data.total_payment)}</div>
            `;
        } catch (error) {
            resultDiv.innerHTML = `<span class="placeholder" style="color: #ef4444;">Error: ${error.message}</span>`;
        }
    });

    // --- Interest Calculator ---
    document.getElementById('btn-interest').addEventListener('click', async () => {
        const principal = document.getElementById('interest-principal').value;
        const rate = document.getElementById('interest-rate').value;
        const time = document.getElementById('interest-time').value;
        const type = document.getElementById('interest-type').value;
        const frequency = document.getElementById('interest-frequency').value;
        const resultDiv = document.getElementById('result-interest');

        if (!principal || !rate || !time) {
            resultDiv.innerHTML = '<span class="placeholder" style="color: #ef4444;">Please fill all fields</span>';
            return;
        }

        resultDiv.innerHTML = '<span class="placeholder">Calculating...</span>';

        try {
            const response = await fetch('/.netlify/functions/interest', {
                method: 'POST',
                body: JSON.stringify({ principal, rate, time, type, frequency })
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();

            resultDiv.innerHTML = `
                <div class="result-value">${formatCurrency(data.total_amount)}</div>
                <div class="result-detail">Interest Earned: ${formatCurrency(data.interest_earned)}</div>
            `;
        } catch (error) {
            resultDiv.innerHTML = `<span class="placeholder" style="color: #ef4444;">Error: ${error.message}</span>`;
        }
    });
    // --- Present Value Calculator ---
    document.getElementById('btn-pv').addEventListener('click', async () => {
        const future_value = document.getElementById('pv-future-value').value;
        const rate = document.getElementById('pv-rate').value;
        const years = document.getElementById('pv-years').value;
        const frequency = document.getElementById('pv-frequency').value;
        const resultDiv = document.getElementById('result-pv');

        if (!future_value || !rate || !years) {
            resultDiv.innerHTML = '<span class="placeholder" style="color: #ef4444;">Please fill all fields</span>';
            return;
        }

        resultDiv.innerHTML = '<span class="placeholder">Calculating...</span>';

        try {
            const response = await fetch('/.netlify/functions/present_value', {
                method: 'POST',
                body: JSON.stringify({ future_value, rate, years, frequency })
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();

            resultDiv.innerHTML = `
                <div class="result-value">${formatCurrency(data.present_value)}</div>
                <div class="result-detail">To reach ${formatCurrency(data.future_value)} in ${data.years} years</div>
                <div class="result-detail">Interest Needed: ${formatCurrency(data.interest_needed)}</div>
            `;
        } catch (error) {
            resultDiv.innerHTML = `<span class="placeholder" style="color: #ef4444;">Error: ${error.message}</span>`;
        }
    });
});
